#!/usr/bin/env node
/**
 * Build-time asset manifest generator.
 *
 * Scans public/assets/ and writes lib/generated/assetManifest.ts
 * so runtime code can resolve asset paths without trial-and-error
 * HTTP requests (which cause 404s in dev-server logs).
 *
 * Run: node scripts/build-asset-manifest.mjs
 */

import { readdirSync, statSync, writeFileSync, mkdirSync } from "fs";
import { join, relative, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT = join(__dirname, "..");
const PUBLIC = join(ROOT, "public");
const ASSETS_DIR = join(PUBLIC, "assets");
const OUT_FILE = join(ROOT, "lib", "generated", "assetManifest.ts");

/** Recursively collect every file under `dir`, returning paths relative to `public/`. */
function walk(dir) {
  const results = [];
  let entries;
  try {
    entries = readdirSync(dir);
  } catch {
    return results;
  }
  for (const entry of entries) {
    const full = join(dir, entry);
    let stat;
    try {
      stat = statSync(full);
    } catch {
      continue;
    }
    if (stat.isDirectory()) {
      results.push(...walk(full));
    } else {
      // Path relative to public/ — this is the URL path the browser requests
      const rel = "/" + relative(PUBLIC, full).replace(/\\/g, "/");
      results.push(rel);
    }
  }
  return results;
}

const files = walk(ASSETS_DIR).sort();

// Build a directory index: dir → list of filenames
const byDir = {};
for (const f of files) {
  const lastSlash = f.lastIndexOf("/");
  const dir = f.slice(0, lastSlash);
  const name = f.slice(lastSlash + 1);
  if (!byDir[dir]) byDir[dir] = [];
  byDir[dir].push(name);
}

// Generate TypeScript
const lines = [
  "// AUTO-GENERATED by scripts/build-asset-manifest.mjs — do not edit manually.",
  "// Regenerate with: node scripts/build-asset-manifest.mjs",
  "",
  "/** Set of every asset path under public/assets/ (relative to public/). */",
  "export const ASSET_FILES: ReadonlySet<string> = new Set([",
];

for (const f of files) {
  lines.push(`  ${JSON.stringify(f)},`);
}
lines.push("]);");
lines.push("");
lines.push("/** Files indexed by directory. Key = dir path (e.g. '/assets/teams/nba'), value = filenames. */");
lines.push("export const ASSETS_BY_DIR: Readonly<Record<string, readonly string[]>> = {");
for (const [dir, names] of Object.entries(byDir).sort(([a], [b]) => a.localeCompare(b))) {
  lines.push(`  ${JSON.stringify(dir)}: [${names.map(n => JSON.stringify(n)).join(", ")}],`);
}
lines.push("};");
lines.push("");

mkdirSync(dirname(OUT_FILE), { recursive: true });
writeFileSync(OUT_FILE, lines.join("\n"), "utf-8");

console.log(`[asset-manifest] Wrote ${files.length} assets to ${relative(ROOT, OUT_FILE)}`);
